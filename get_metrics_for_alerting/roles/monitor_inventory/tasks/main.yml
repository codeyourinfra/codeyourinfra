---
- name: Create the Ansible directory if it doesn't exist
  file:
    path: /etc/ansible
    state: directory
- name: Copy the Ansible inventory
  copy:
    src: monitored_hosts
    dest: /etc/ansible/hosts
    force: false
- name: Disable SSH key host checking
  ini_file:
    path: /etc/ansible/ansible.cfg
    section: defaults
    option: host_key_checking
    value: False

- block:
    - name: Install sshpass
      apt:
        name: sshpass
        update_cache: true
    - name: Add the server into the monitored_servers group
      lineinfile:
        path: /etc/ansible/hosts
        insertafter: "^\\[monitored_servers\\]$"
        line: "{{ host }} ansible_user={{ user }} ansible_ssh_pass={{ password }}"
  when: host is defined and user is defined and password is defined

- block:
    - name: Copy the SSH user private key
      copy:
        src: "{{ private_key }}"
        dest: "/etc/ansible/{{ host }}.private_key"
        mode: 0400
    - name: Add the server into the monitored_servers group
      lineinfile:
        path: /etc/ansible/hosts
        insertafter: "^\\[monitored_servers\\]$"
        line: "{{ host }} ansible_user={{ user }} ansible_ssh_private_key_file=/etc/ansible/{{ host }}.private_key"
  when: host is defined and user is defined and private_key is defined
